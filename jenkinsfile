// Jenkinsfile
String credentialsId = 'awsCredentials'

stage('checkout') {
    node {
        cleanWs()
        checkout scm
    }
}

// Run terraform init
stage('init') {
    node {
        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: credentialsId, accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']])
        sh 'terraform init'
    }
}

// Run terraform plan
stage('plan') {
    node {
        withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: credentialsId, accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']])
        sh 'terraform plan'
    }
}

// Run terraform apply
// stage('apply') {
//     node {
//         withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', credentialsId: credentialsId, accessKeyVariable: 'AWS_ACCESS_KEY_ID', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']])
//         sh 'terraform apply -auto-approve'
//     }
// }